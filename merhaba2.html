<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Token API Endpoint</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
            background: white;
            color: black;
            max-width: 1000px;
            margin: 0 auto;
        }
        .token {
            font-size: 14px;
            word-break: break-all;
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            margin: 20px 0;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h2>Token Görüntüleyici</h2>
    
    <div class="info">
        Bu sayfa, API'den alınan token'i hem ekranda gösterir hem de API isteklerine yanıt olarak döndürür.
        <br><br>
        API endpoint'i olarak kullanmak için: <strong>?api=true</strong> parametresi ekleyin.
    </div>
    
    <div id="tokenResult">Token bilgisi alınıyor...</div>

    <script>
        // URL parametrelerini kontrol et
        const urlParams = new URLSearchParams(window.location.search);
        const apiRequest = urlParams.get('api');
        
        // API isteği için özel fonksiyon
        async function handleTokenRequest() {
            try {
                const token = await fetchTokenFromAPI();
                
                // Eğer API isteği yapıldıysa, sadece token'i döndür ve sayfayı sonlandır
                if (apiRequest) {
                    // Content-Type header'ını text/plain olarak ayarla
                    document.body.innerHTML = token;
                    // Sayfa yüklemeyi durdur ve token'i döndür
                    document.write(token);
                    document.close();
                    return;
                }
                
                // Normal kullanıcı arayüzü için token'i göster
                document.getElementById('tokenResult').innerHTML = `<div class="token">${token}</div>`;
            } catch (error) {
                if (apiRequest) {
                    document.body.innerHTML = `Hata: ${error.message}`;
                } else {
                    document.getElementById('tokenResult').innerText = `Hata: ${error.message}`;
                }
            }
        }

        // Token'i API'den al
        async function fetchTokenFromAPI() {
            const API_URL = "https://core-api.kablowebtv.com/api/channels";
            const HEADERS = {
                "User-Agent": "Mozilla/5.0",
                "Referer": "https://tvheryerde.com",
                "Origin": "https://tvheryerde.com",
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbnYiOiJMSVZFIiwiaXBiIjoiMCIsImNnZCI6IjA5M2Q3MjBhLTUwMmMtNDFlZC1hODBmLTJiODE2OTg0ZmI5NSIsImNzaCI6IlRSS1NUIiwiZGN0IjoiRTFDNjQiLCJkaSI6Ijg5MTlmNjYwLTBhZGUtNGYwMS1hMTVlLTc2MDZjNjI4ZTc5MyIsInNnZCI6IjM5MTY0ZjIwLTZlZjUtNDRlZS04ZjAyLWEzODRjOTg1ZTY5MyIsInNwZ2QiOiI5ZjJlYWE1NC01NDM2LTQ0ZTgtYTkyNy00MzQ2NjlkMTU1MWEiLCJpY2giOiIwIiwiaWRtIjoiMCIsImlhIjoiOjpmZmZmOjEwLjAuMC41IiwiYXB2IjoiMS4wLjAiLCJhYm4iOiIxMDAwIiwibmJmIjoxNzQzNDY1MzY5LCJleHAiOjE3NDM0NjU0MjksImlhdCI6MTc0MzQ2NTM2OX0.YWdVfOL5hEZTrd4f4qkmPCPmUUlaiG7I2REW5H0p6Gw"
            };

            const res = await fetch(API_URL, { headers: HEADERS, method: 'GET' });
            if (!res.ok) throw new Error(`API hatası: ${res.status}`);
            
            const data = await res.json();
            if (!data.IsSucceeded || !data.Data || !data.Data.AllChannels)
                throw new Error("Geçersiz API yanıtı");

            // 'atv' kanalını bul
            const atvChannel = data.Data.AllChannels.find(ch => 
                ch && ch.StreamData && ch.StreamData.HlsStreamUrl && 
                ch.StreamData.HlsStreamUrl.includes('atv_stream')
            );
            
            if (atvChannel && atvChannel.StreamData.HlsStreamUrl) {
                const url = atvChannel.StreamData.HlsStreamUrl;
                const prefix = "https://ottcdn.kablowebtv.net/live_turksat_sub3/atv_stream/index.m3u8?wmsAuthSign=";
                
                if (url.startsWith(prefix)) {
                    return url.substring(prefix.length);
                } else {
                    throw new Error("ATV URL'si beklenen formatta değil");
                }
            } else {
                throw new Error("ATV kanalı veya stream URL bulunamadı");
            }
        }

        // Sayfa yüklendiğinde token'i al
        handleTokenRequest();
    </script>
</body>
</html>
