<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YouTube HLS Player</title>
    <style>
        body { margin: 0; padding: 0; background: #000; }
        video { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <video id="player" controls autoplay></video>
    <div id="status" style="position: fixed; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;"></div>

    <script>
        // Cookie storage için basit bir mekanizma
        const cookieStorage = {
            getCookies: () => {
                return localStorage.getItem('ytCookies') || '';
            },
            setCookies: (cookies) => {
                localStorage.setItem('ytCookies', cookies);
                localStorage.setItem('ytCookiesTimestamp', Date.now());
            },
            shouldRefreshCookies: () => {
                const timestamp = localStorage.getItem('ytCookiesTimestamp');
                return !timestamp || (Date.now() - timestamp) > 3600000; // 1 saat
            }
        };

        // URL parametrelerini al
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('id');

        if (!videoId) {
            showError('HATA: URL parametresi olarak id gereklidir. Örnek: ?id=MSlOWVOF84o');
        } else {
            playVideo(videoId);
        }

        function showError(message) {
            document.getElementById('status').textContent = message;
            document.body.style.background = '#300';
        }

        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function playVideo(videoId) {
            showStatus('YouTube cookies alınıyor...');

            try {
                // 1. Cookie'leri al veya yenile
                let cookies = cookieStorage.getCookies();
                
                if (cookieStorage.shouldRefreshCookies() || !cookies) {
                    showStatus('Yeni cookies alınıyor...');
                    cookies = await fetchYouTubeCookies();
                    cookieStorage.setCookies(cookies);
                }

                // 2. M3U8 URL'sini al
                showStatus('M3U8 URL aranıyor...');
                const m3u8Url = await fetchM3U8Url(videoId, cookies);
                
                if (m3u8Url) {
                    showStatus('M3U8 bulundu! Oynatılıyor...');
                    document.getElementById('player').src = m3u8Url;
                } else {
                    showError('M3U8 URL bulunamadı. Cookies yenileniyor...');
                    // Cookies'i yenile ve tekrar dene
                    const newCookies = await fetchYouTubeCookies();
                    cookieStorage.setCookies(newCookies);
                    const retryUrl = await fetchM3U8Url(videoId, newCookies);
                    
                    if (retryUrl) {
                        showStatus('M3U8 bulundu! Oynatılıyor...');
                        document.getElementById('player').src = retryUrl;
                    } else {
                        showError('M3U8 URL bulunamadı');
                    }
                }

            } catch (error) {
                showError('Hata: ' + error.message);
                console.error(error);
            }
        }

        async function fetchYouTubeCookies() {
            try {
                const response = await fetch('https://corsproxy.io/?https://m.youtube.com', {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
                    }
                });

                const cookieHeader = response.headers.get('set-cookie') || '';
                return parseCookies(cookieHeader);

            } catch (error) {
                console.error('Cookie alma hatası:', error);
                return '';
            }
        }

        function parseCookies(cookieHeader) {
            const cookies = [];
            const cookieLines = cookieHeader.split(',');

            for (const line of cookieLines) {
                if (line.includes('VISITOR_INFO1_LIVE=') || 
                    line.includes('VISITOR_PRIVACY_METADATA=') || 
                    line.includes('__Secure-ROLLOUT_TOKEN=')) {
                    
                    const cookie = line.split(';')[0].trim();
                    cookies.push(cookie);
                }
            }

            return cookies.join('; ');
        }

        async function fetchM3U8Url(videoId, cookies) {
            try {
                const url = `https://corsproxy.io/?https://m.youtube.com/watch?v=${videoId}&app=TABLET`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.58 Mobile Safari/537.36',
                        'Accept': '*/*',
                        'Cookie': cookies,
                        'X-YouTube-Client-Name': '2',
                        'X-YouTube-Client-Version': '2.20250523.01.00'
                    }
                });

                const text = await response.text();
                
                // hlsManifestUrl'yi ara
                const regex = /"hlsManifestUrl":"(https:\/\/[^"]+\.m3u8[^"]*)"/;
                const match = text.match(regex);
                
                if (match && match[1]) {
                    return match[1].replace(/\\u0026/g, '&');
                }

                return null;

            } catch (error) {
                console.error('M3U8 alma hatası:', error);
                return null;
            }
        }

        // 1 saatte bir cookies yenileme
        setInterval(() => {
            if (cookieStorage.shouldRefreshCookies()) {
                fetchYouTubeCookies().then(cookies => {
                    cookieStorage.setCookies(cookies);
                });
            }
        }, 300000); // 5 dakikada bir kontrol
    </script>
</body>
</html>
