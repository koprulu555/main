<?php
header('Content-Type: text/plain');
header('Access-Control-Allow-Origin: *');

// Parametreleri al
$channelId = $_GET['kanal_id'] ?? '';
$videoId = $_GET['video_id'] ?? '';

// Hangi ID'nin kullanılacağını belirle
$Live = '';
$isVideo = false;

if (!empty($videoId)) {
    $Live = $videoId;
    $isVideo = true;
} elseif (!empty($channelId)) {
    $Live = $channelId;
} else {
    die("Geçersiz istek. Lütfen bir YouTube kanal ID'si (kanal_id) veya video ID'si (video_id) belirtin.");
}

// YouTube'dan cookies al
$ch = curl_init('https://m.youtube.com/');
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_ENCODING, false);
curl_setopt($ch, CURLOPT_HEADER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, array(
    'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
    'Accept-Encoding: gzip, deflate',
    'Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
    'User-Agent: Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.58 Mobile Safari/537.36',
));
$site = curl_exec($ch);
curl_close($ch);

// Cookies'leri parse et
$visitor_info = '';
$visitor_metadata = '';
$rollout_token = '';

if (preg_match('/VISITOR_INFO1_LIVE=([^;]+)/', $site, $matches)) {
    $visitor_info = $matches[1];
}
if (preg_match('/VISITOR_PRIVACY_METADATA=([^;]+)/', $site, $matches)) {
    $visitor_metadata = $matches[1];
}
if (preg_match('/__Secure-ROLLOUT_TOKEN=([^;]+)/', $site, $matches)) {
    $rollout_token = $matches[1];
}

// İstek URL'sini oluştur
if ($isVideo) {
    $request_url = 'https://m.youtube.com/watch?v='.$Live.'&app=TABLET';
} else {
    $request_url = 'https://m.youtube.com/channel/'.$Live.'/live?app=TABLET';
}

// M3U8 URL'sini al
$ch = curl_init($request_url);
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_ENCODING, false);
curl_setopt($ch, CURLOPT_HTTPHEADER, array(
    'Accept: */*',
    'Accept-Encoding: gzip, deflate',
    'Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
    'Cookie: VISITOR_INFO1_LIVE='.$visitor_info.'; VISITOR_PRIVACY_METADATA='.$visitor_metadata.'; __Secure-ROLLOUT_TOKEN='.$rollout_token,
    'User-Agent: Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.58 Mobile Safari/537.36',
    'X-YouTube-Client-Name: 2',
    'X-YouTube-Client-Version: 2.20250523.01.00',
));
$site1 = curl_exec($ch);
curl_close($ch);

// hlsManifestUrl'yi çıkar
if (preg_match('/"hlsManifestUrl":"([^"]+)"/', $site1, $matches)) {
    $m3u8_url = str_replace('\\u0026', '&', $matches[1]);
    echo $m3u8_url;
} else {
    echo "Hata: M3U8 URL'si bulunamadı";
}
?>
