<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YouTube M3U8 Player</title>
    <style>
        body { margin: 0; padding: 0; background: #000; }
        video { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <video id="player" controls autoplay></video>

    <script>
        // URL parametrelerini al
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('video_id');
        const kanalId = urlParams.get('kanal_id');

        if (!videoId && !kanalId) {
            document.body.innerHTML = '<h1 style="color:white;text-align:center;">HATA: video_id veya kanal_id parametresi gerekli</h1>';
        } else {
            playVideo();
        }

        async function playVideo() {
            const id = videoId || kanalId;
            const isVideo = !!videoId;
            
            try {
                // Proxy ile YouTube sayfasını al
                let youtubeUrl;
                if (isVideo) {
                    youtubeUrl = `https://www.youtube.com/watch?v=${id}`;
                } else {
                    youtubeUrl = `https://www.youtube.com/channel/${id}/live`;
                }

                const proxyUrl = `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(youtubeUrl)}`;
                
                console.log('Proxy URL:', proxyUrl);
                
                const response = await fetch(proxyUrl, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                        'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const html = await response.text();
                
                console.log('HTML alındı, uzunluk:', html.length);
                
                // hlsManifestUrl'yi ara
                const regex = /"hlsManifestUrl":"(https:\/\/[^"]+\.m3u8[^"]*)"/;
                const match = html.match(regex);
                
                if (match && match[1]) {
                    const m3u8Url = match[1].replace(/\\u0026/g, '&');
                    console.log('M3U8 URL bulundu:', m3u8Url);
                    
                    // Videoyu oynat
                    document.getElementById('player').src = m3u8Url;
                    return;
                }

                // Alternatif arama
                const altRegex = /(https:\/\/manifest\.googlevideo\.com[^"]+\.m3u8)/;
                const altMatch = html.match(altRegex);
                
                if (altMatch && altMatch[1]) {
                    const m3u8Url = altMatch[1].replace(/\\u0026/g, '&');
                    console.log('Alternatif M3U8 URL bulundu:', m3u8Url);
                    document.getElementById('player').src = m3u8Url;
                    return;
                }

                // Son çare: embed sayfasını dene
                console.log('Ana sayfada bulunamadı, embed sayfası deneniyor...');
                await tryEmbedPage(id);

            } catch (error) {
                console.error('Hata:', error);
                document.body.innerHTML = `
                    <h1 style="color:white;text-align:center;">
                        HATA: ${error.message}
                    </h1>
                `;
            }
        }

        async function tryEmbedPage(videoId) {
            try {
                const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                const proxyUrl = `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(embedUrl)}`;
                
                const response = await fetch(proxyUrl, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                    }
                });

                const html = await response.text();
                
                const regex = /"hlsManifestUrl":"(https:\/\/[^"]+\.m3u8[^"]*)"/;
                const match = html.match(regex);
                
                if (match && match[1]) {
                    const m3u8Url = match[1].replace(/\\u0026/g, '&');
                    console.log('Embed sayfasında M3U8 URL bulundu:', m3u8Url);
                    document.getElementById('player').src = m3u8Url;
                } else {
                    throw new Error('M3U8 URL hiçbir sayfada bulunamadı');
                }

            } catch (error) {
                console.error('Embed hatası:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
